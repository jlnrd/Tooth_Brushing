---
title: "Daily Fluctuations in Teeth Brushing"
output: html_document
---

<style type="text/css">
h1 {
  font-size: 36px;
  margin-top: 60px;
  margin-bottom: 30px;
}

h2 {
  font-size: 28px;

}

h3 {
  font-size: 24px;
  padding-top: 30px;
  margin-bottom: 0px;
  text-align: left !important;
}

h4 {
  font-size: 18px;
}

p {
  font-size: 16px;
  text-align: left;
}

h1, h2, h3, h4, h5, h6 {
  text-align: center;
}

.p-text-align-right {
  text-align: right !important;
}

</style>

```{r, include=FALSE,warning=FALSE}
# clean workspace
rm(list=ls())

# load required packages
packages <- c("ggplot2", "ggpubr", "PerformanceAnalytics", "dplyr")
lapply(packages, library, character.only = TRUE)

# standardize ggplot2
theme_set(theme_bw() + theme( plot.title = element_text(size=18, lineheight=1, margin=margin(b=15, t=30), hjust = 0.5),
         axis.title.x = element_text(size=14, lineheight=1, margin=margin(t=15)),
         axis.title.y = element_text(size=14, lineheight=1, margin=margin(r=15))))

##################
## read in data ##
##################
daily_fluctuations<-read.csv("/Users/appollo_liu/Documents/workspace/Tooth_Brushing/data/clean_updated_brushing.csv", header=TRUE)

invalid_dates <- c('1/31/19', '2/28/19', '3/21/19', '4/3/19', '6/10/19')
# take out all of the data from the first day of the study, any data from an unusual day, and any data where there was no survey submitted for that day 
daily_fluctuations<-filter(daily_fluctuations, !(date %in% invalid_dates), other_stringent=="0", !is.na(parent_stress))

# makes each "key" in the data object its own variable
# Example: data$record_id is now record_id
attach(daily_fluctuations)

# find the overall participant information
# find the averages of daily fluctuations for each subject
average_time_brushing <- with(daily_fluctuations, ave(time_brushing, subject, FUN=function(x) mean(x, na.rm=TRUE)))
standard_deviation_time_brushing <- with(daily_fluctuations, ave(time_brushing, subject, FUN=function(x) sd(x, na.rm=TRUE)))
coefficient_of_variation_time_brushing <- standard_deviation_time_brushing/average_time_brushing

average_encouragements <- with(daily_fluctuations, ave(total_encouragements, subject, FUN=function(x) mean(x, na.rm=TRUE)))
standard_deviation_encouragements <- with(daily_fluctuations, ave(total_encouragements, subject, FUN=function(x) sd(x, na.rm=TRUE)))
coefficient_of_variation_encouragements <- standard_deviation_encouragements/average_encouragements

average_parent_stress <- with(daily_fluctuations, ave(parent_stress, subject, FUN=function(x) mean(x, na.rm=TRUE)))
standard_deviation_parent_stress <- with(daily_fluctuations, ave(parent_stress, subject, FUN=function(x) sd(x, na.rm=TRUE)))
coefficient_of_variation_parent_stress <- standard_deviation_parent_stress/average_parent_stress

average_time_sleep <- with(daily_fluctuations, ave(time_sleep, subject, FUN=function(x) mean(x, na.rm=TRUE)))
standard_deviation_time_sleep <- with(daily_fluctuations, ave(time_sleep, subject, FUN=function(x) sd(x, na.rm=TRUE)))
coefficient_of_variation_time_sleep <- standard_deviation_time_sleep/average_time_sleep

average_parent_mood <- with(daily_fluctuations, ave(parent_mood, subject, FUN=function(x) mean(x, na.rm=TRUE)))
standard_deviation_parent_mood <- with(daily_fluctuations, ave(parent_mood, subject, FUN=function(x) sd(x, na.rm=TRUE)))
coefficient_of_variation_parent_mood <- standard_deviation_parent_mood/average_parent_mood

average_child_mood <- with(daily_fluctuations, ave(child_mood, subject, FUN=function(x) mean(x, na.rm=TRUE)))
standard_deviation_child_mood <- with(daily_fluctuations, ave(child_mood, subject, FUN=function(x) sd(x, na.rm=TRUE)))
coefficient_of_variation_child_mood <- standard_deviation_child_mood/average_child_mood

average_time_sleep_nonap <- with(daily_fluctuations, ave(time_sleep_nonap, subject, FUN=function(x) mean(x, na.rm=TRUE)))
standard_deviation_time_sleep_nonap <- with(daily_fluctuations, ave(time_sleep_nonap, subject, FUN=function(x) sd(x, na.rm=TRUE)))
coefficient_of_variation_time_sleep_nonap <- standard_deviation_time_sleep_nonap/average_time_sleep_nonap

overall_subject <- data.frame("subject_ID" = subject, "mean_time_brushing" = average_time_brushing, "sd_time_brushing" = standard_deviation_time_brushing, "cv_time_brushing" = coefficient_of_variation_time_brushing, "mean_encouragements" = average_encouragements, "sd_encouragements" = standard_deviation_encouragements, "cv_encouragements" = coefficient_of_variation_encouragements, "mean_parent_stress" = average_parent_stress, "sd_parent_stress" = standard_deviation_parent_stress, "cv_parent_stress" = coefficient_of_variation_parent_stress, "mean_time_sleep" = average_time_sleep, "sd_time_sleep" = standard_deviation_time_sleep, "cv_time_sleep" = coefficient_of_variation_time_sleep, "mean_parent_mood" = average_parent_mood, "sd_parent_mood" = standard_deviation_parent_mood, "cv_parent_mood" = coefficient_of_variation_parent_mood, "mean_child_mood" = average_child_mood, "sd_child_mood" = standard_deviation_child_mood, "cv_child_mood" = coefficient_of_variation_child_mood, "mean_time_sleep_nonap" = average_time_sleep_nonap, "sd_time_sleep_nonap" = standard_deviation_time_sleep_nonap, "cv_time_sleep_nonap" = coefficient_of_variation_time_sleep_nonap)

overall_subject <- overall_subject[!duplicated(overall_subject$subject_ID),]
```

### Subject box plots

```{r,warning=FALSE,fig.width=10, fig.height=8,echo = FALSE}
# plot subject brushing length
brushing_length_vs_subject <- ggplot(data=daily_fluctuations, mapping=aes(x=as.factor(subject), y=time_brushing))
brushing_length_vs_subject +
  geom_boxplot() +
  stat_summary(fun.y="mean", geom="point", shape=9, size=3) +
  labs(title="Subject Brushing Length", x="Subject",y="Brushing length (seconds)")
```

```{r,warning=FALSE,fig.width=10, fig.height=8,echo = FALSE}
# plot subject sleep
sleep_length_vs_subject <- ggplot(data=daily_fluctuations, mapping=aes(x=as.factor(subject), y=time_sleep))
sleep_length_vs_subject +
  geom_boxplot() +
  stat_summary(fun.y="mean", geom="point", shape=9, size=3) +
  labs(title="Subject Sleep", x="Subject",y="Sleep (hours)")
```

### Within Subject Relationships

```{r,warning=FALSE,fig.width=10, fig.height=8,echo = FALSE}
# plot time brushing vs. encouragements
within_subject_time_brushing_vs_encouragements <- ggplot(data=daily_fluctuations, aes(x=total_encouragements, y=time_brushing))
within_subject_time_brushing_vs_encouragements + 
  facet_wrap(~subject) +
  geom_point(shape=1) +
  geom_smooth(method=lm, se=FALSE, fullrange=FALSE) +
  stat_cor(method = "pearson",  size =3) +
  labs(title="Time Brushing vs. Encouragements", x="Encouragements",y="Time brushing (seconds)")

# plot time brushing vs. time sleep
within_subject_time_brushing_vs_time_sleep <- ggplot(data=daily_fluctuations, aes(x=time_sleep, y=time_brushing))
within_subject_time_brushing_vs_time_sleep + 
  facet_wrap(~subject) +
  geom_point(shape=1) +
  geom_smooth(method=lm, se=FALSE, fullrange=FALSE) +
  stat_cor(method = "pearson",  size =3) +
  labs(title="Time Brushing vs. Child Sleep", x="Child sleep (hours)",y="Time brushing (seconds)")

# plot time_brushing vs. child mood
within_subject_time_brushing_vs_child_mood <- ggplot(data=daily_fluctuations, aes(x=child_mood, y=time_brushing))
within_subject_time_brushing_vs_child_mood + 
  facet_wrap(~subject) +
  geom_point(shape=1) +
  geom_smooth(method=lm, se=FALSE, fullrange=FALSE) +
  stat_cor(method = "pearson",  size =3) +
  labs(title="Time Brushing vs. Child Mood", x="Child mood", y="Time brushing (seconds)")

# plot encouragements vs. child sleep
within_subject_encouragements_vs_child_sleep <- ggplot(data=daily_fluctuations, aes(x=time_sleep, y=total_encouragements))
within_subject_encouragements_vs_child_sleep + 
  facet_wrap(~subject) +
  geom_point(shape=1) +
  geom_smooth(method=lm, se=FALSE, fullrange=FALSE) +
  stat_cor(method = "pearson",  size =3) +
  labs(title="Encouragements vs. Child Sleep", x="Child sleep (hours)",y="Encouragements")

# plot encouragements vs. child mood
within_subject_encouragements_vs_child_mood <- ggplot(data=daily_fluctuations, aes(x=child_mood, y=total_encouragements))
within_subject_encouragements_vs_child_mood + 
  facet_wrap(~subject) +
  geom_point(shape=1) +
  geom_smooth(method=lm, se=FALSE, fullrange=FALSE) +
  stat_cor(method = "pearson",  size =3) +
  labs(title="Encouragements vs. Child Mood", x="Child mood",y="Encouragements")
```

### Within Subject Correlation Matrices
```{r,warning=FALSE,fig.width=10, fig.height=8,echo = FALSE}
subject_daily_fluctuations <- filter(daily_fluctuations, subject=="101")
chart.Correlation(dplyr::select(subject_daily_fluctuations, time_brushing, total_encouragements, parent_stress, parent_mood, child_mood, time_sleep), histogram=TRUE, pch=19)
```

```{r,warning=FALSE,fig.width=10, fig.height=8,echo = FALSE}
# unique(daily_fluctuations$subject)
for (subject_id in unique(daily_fluctuations$subject)) {
  subject_daily_fluctuations <- filter(daily_fluctuations, subject==subject_id)
  chart.Correlation(dplyr::select(subject_daily_fluctuations, time_brushing, total_encouragements, parent_stress, parent_mood, child_mood, time_sleep), histogram=TRUE, pch=19)
}
```

<p>
  Note: The symbols show these p-values. 0.001:"***", 0.01: "**", 0.05: "*", 0.10: ".")
</p>

#### Looking at Child Brushing Extremes

```{r,warning=FALSE,fig.width=10, fig.height=8,echo = FALSE}
worst_time_brushing<-filter(daily_fluctuations, brushing_rank=="worst")
best_time_brushing<-filter(daily_fluctuations, brushing_rank=="best")

between_subject_worst_brushing_sleep_vs_mean_sleep <- ggplot()
between_subject_worst_brushing_sleep_vs_mean_sleep +
  geom_point(data=overall_subject, aes(x=subject_ID, y=mean_time_sleep), shape=5, size=4) +
  geom_point(data=worst_time_brushing, aes(x=subject, y=time_sleep), shape=1, size=4) +
  labs(title="Subject Worst Night Brushing Sleep vs. Average Sleep", x="Subject", y="Child sleep (hours)", color="Sleep")
```

```{r,warning=FALSE}
sum(overall_subject$mean_time_sleep > worst_time_brushing$time_sleep)
length(overall_subject$mean_time_sleep)
```

### Between Subject Relationships

```{r,warning=FALSE,fig.width=10, fig.height=8,echo = FALSE}
# has unusually data
# overall_subject<-filter(overall_subject, subject!="120", subject!="101")

# plot brushing length vs. encouragements 
between_subject_brushing_length_vs_encouragements <- ggplot(data=overall_subject, mapping=aes(x=mean_encouragements, y=mean_time_brushing))
between_subject_brushing_length_vs_encouragements +
  stat_cor(method = "pearson",  size = 6) +
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE) +
  geom_point(shape=1) +
  labs(title="Brushing Length vs. Encouragements", x="Encouragements", y="Brushing length")

# plot brushing length vs. child sleep
between_subject_brushing_length_vs_child_sleep <- ggplot(data=overall_subject, mapping=aes(x=mean_time_sleep, y=mean_time_brushing))
between_subject_brushing_length_vs_child_sleep +
  stat_cor(method = "pearson",  size = 6) +
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE) +
  geom_point(shape=1) +
  labs(title="Brushing Length vs. Child Sleep", x="Child sleep (hours)", y="Brushing length (seconds)")

# plot brushing length vs. child mood
between_subject_brushing_length_vs_child_mood <- ggplot(data=overall_subject, mapping=aes(x=mean_child_mood, y=mean_time_brushing))
between_subject_brushing_length_vs_child_mood +
  stat_cor(method = "pearson",  size = 6) +
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE) +
  geom_point(shape=1) +
  labs(title="Brushing Length vs. Child Mood", x="Child sleep mood", y="Brushing length (seconds)")

# plot encouragements vs. child sleep
between_subject_encouragements_vs_time_sleep <- ggplot(data=overall_subject, mapping=aes(x=mean_time_sleep, y=mean_encouragements))
between_subject_encouragements_vs_time_sleep +
  stat_cor(method = "pearson",  size = 6) +
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE) +
  geom_point(shape=1) +
  labs(title="Encouragement vs. Child sleep", x="Child sleep (hours)", y="Encouragement")

# plot encouragements vs. child mood
between_subject_encouragements_vs_child_mood <- ggplot(data=overall_subject, mapping=aes(x=mean_child_mood, y=mean_encouragements))
between_subject_encouragements_vs_child_mood +
  stat_cor(method = "pearson",  size = 6) +
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE) +
  geom_point(shape=1) +
  labs(title="Encouragement vs. Child Mood", x="Child mood", y="Encouragement")
```

#### Between Subject Correlation Matrices

```{r,warning=FALSE,fig.width=10, fig.height=8,echo = FALSE}
attach(overall_subject)
# cbind() combines two matrices that have the same number of rows together
between_subject_averages <- cbind(mean_time_brushing, mean_encouragements, mean_parent_stress, mean_parent_mood, mean_child_mood, mean_time_sleep)

between_subject_mean_and_sd <- cbind(mean_time_brushing, sd_time_brushing, mean_encouragements, sd_encouragements, mean_parent_stress, sd_parent_stress, mean_parent_mood, sd_parent_mood, mean_child_mood, sd_child_mood, mean_time_sleep, sd_time_sleep)

between_subject_cv <- cbind(cv_time_brushing, cv_encouragements, cv_parent_stress, cv_time_sleep, cv_parent_mood, cv_child_mood)
detach(overall_subject)

# graphing the correlation matrix
# pch controls the type of point that is displayed in the scatter plots
chart.Correlation(between_subject_averages, histogram=TRUE, pch=19)

chart.Correlation(between_subject_mean_and_sd, histogram=TRUE, pch=19)

chart.Correlation(between_subject_cv, histogram=TRUE, pch=19)
```
<p>
  List of all correlations in mean and standard deviation correlation matrix:
    1. mean_time_brushing & sd_time_brushing: +
    2. mean_time_brushing & mean_encouragement: +
    3. mean_time_brushing & sd_encouragement: +. Makes sense, the more child brushing, the more variation in how much time the parent has to give more encouragements.
    4. mean_time_brushing & mean_parent_stress: -
    5. sd_time_brushing & mean_encouragement: +. The greater the variation in brushing, the more encouragement. This could be that because the parent knows that the child has the potential to brush more, the parent can try to offer more encouragement to the child so that the child is reaching their "highest potential" time brushing.
    6. sd_time_brushing & sd_encouragement: +
    7. sd_time_brushing & mean_parent_stress: -. Higher variation in brushing correlates with lower average parent stress. Would have thought that higher variation would cause parent stress to be higher because the parent doesn't know what's going to happen.
    8. mean_encouragement & sd_encouragement: +. Similar to correlation to mean_time_brushing & sd_time_brushing: the greater the average number of encouragements, the greater the variation in the total number of encouragements.
    9. sd_encouragement & mean_child_mood: -. Higher variation in encouragment correlates with lower average child mood. Kind of makes sense: if the child is unhappy, parents may react differently by either giving a lot of encouragement or give no encouragement and give up.
    10. mean_parent_stress & mean_parent_mood: -
    11. mean_parent_stress & mean_child_mood: -
    12. sd_parent_stress & sd_parent_mood: +
    13. mean_parent_mood & sd_parent_mood: -
    14. mean_parent_mood & mean_child_mood: +
    15. mean_parent_mood & sd_time_sleep: +. High average parent mood correlates with high variation in child sleep. Not really sure because would have assummed that low variation in child sleep would make the parent happier.
    16. sd_parent_mood & sd_child_mood: +
    17. sd_parent_mood & mean_time_sleep: -. High variation in parent mood correlates with lower child sleep. Kind of makes sense: parent mood varies more when the child sleeps less.
    18. mean_child_mood & sd_child_mood: -. High average child mood correlates with less variation in the child mood.
</p>

<p>
  Interesting finding that the more variation in the child's mood, the more variation there is in time brushing according to the cv correlation matrix.
</p>

<div style="height:60px;">
</div>